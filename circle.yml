machine:
    php:
        version: 5.6.5

dependencies:
    cache_directories:
        - bower_components
        - node_modules
        - ~/.composer
    override:
        - sudo composer self-update:
            timeout: 3600
    pre:
        - sudo apt-get update && sudo apt-get install libfftw3-double3 libmagickcore5 imagemagick
        - yes "" | pecl install imagick
        - echo "memory_limit = 256M" > ~/.phpenv/versions/$(phpenv global)/etc/conf.d/memory.ini
        - echo "always_populate_raw_post_data=-1" > ~/.phpenv/versions/$(phpenv global)/etc/conf.d/custom.ini
        - mysql -u ubuntu -e "create database symfony"
        - mysql -u ubuntu -e "create database symfony_test"
    post:
        - wget http://selenium-release.storage.googleapis.com/2.44/selenium-server-standalone-2.44.0.jar
        - java -jar selenium-server-standalone-2.44.0.jar: {background: true}
        - curl http://get.sensiolabs.org/php-cs-fixer.phar -o php-cs-fixer
        - sudo chmod a+x php-cs-fixer
        - wget https://download.elastic.co/elasticsearch/elasticsearch/elasticsearch-1.7.0.tar.gz
        - tar -xvf elasticsearch-1.7.0.tar.gz
        - elasticsearch-1.7.0/bin/elasticsearch: {background: true}
        - npm install -g brunch@1
        - pip install fabric
        - npm install --production
        - bower install --config.interactive=false
        - composer install --prefer-dist --no-interaction --optimize-autoloader

# This is not a real deployment we only update the code
# because the 'infrastructure' folder which contains the
# dockerfiles is used by deploymenttools
deployment:
    preprod:
        branch: develop
        commands:
            - "ssh capco@***REMOVED*** 'cd CapCollectif-SF2 && git pull'"
            - "ssh capco@***REMOVED*** 'cd CapCollectif-DeploymentTools && fab deploy:preprod'"
test:
    pre:
        - fab build:prod
        - SYMFONY_ENV=test php app/console server:run --router=app/config/router_test.php: {background: true}

    override:
        - fab test
        - fab lint

