machine:
    pre:
        - export DEBIAN_FRONTEND=noninteractive && sudo apt-get remove -y --purge mysql-server mysql-community-server
        - sudo curl -L -o /usr/bin/docker 'https://s3-external-1.amazonaws.com/circle-downloads/docker-1.9.1-circleci'
        - sudo chmod 0755 /usr/bin/docker
        - sudo pip install --upgrade pip
        - sudo apt-get --reinstall install python-dev libffi-dev python-pyasn1 python-pyasn1-modules --yes
        - sudo pip install --upgrade ndg-httpsclient
        - sudo pip install docker-compose==1.8.0 Fabric==1.12.0
    services:
        - docker

dependencies:
    cache_directories:
        - ~/docker
        - ~/.composer
        - ~/.cache/yarn
        - ~/.cache/bower

    override:
        - fab testing.circle.fix_environment_variables_with_lxc
        - fab testing.circle.clean_cache
        - fab testing.circle.load_cache
        - fab testing.circle.save_cache
        - fab testing.infrastructure.up
        - fab testing.app.deploy:environment=test
        - fab testing.qa.save_fixtures_image

test:
    pre:
      - mkdir -p $CIRCLE_TEST_REPORTS/junit/

    override:
        - fab testing.qa.phpspec
        - fab testing.qa.jest
        - fab testing.qa.check_codestyle
        - fab testing.qa.check_dependencies
        - fab testing.qa.static_analysis
        - fab testing.qa.behat:fast_failure=false,profile=api
        - fab testing.qa.behat:fast_failure=false,profile=graphql
        - fab testing.qa.behat:fast_failure=false,profile=commands
        - fab testing.qa.behat:fast_failure=false,profile=frontend
        - fab testing.qa.behat:fast_failure=false,profile=javascript
        - fab testing.qa.behat:fast_failure=false,profile=back
    post:
        - docker ps && docker stop $(docker ps -a -q) && fab testing.circle.save_logs

deployment:
    preprod:
        branch: develop
        commands:
            - "ssh capco@***REMOVED*** 'cd CapCollectif-DeploymentTools && fab deploy:preprod'"
