machine:
    pre:
        - sudo curl -L -o /usr/bin/docker 'https://s3-external-1.amazonaws.com/circle-downloads/docker-1.9.1-circleci'
        - sudo chmod 0755 /usr/bin/docker
    services:
        - docker

dependencies:
    cache_directories:
        - ~/docker
        - bower_components
        #- node_modules
        - ~/.composer
        - ~/.bower
    override:
        - mkdir -p $CIRCLE_TEST_REPORTS/junit/
        - pip install -q -r requirements.txt
        - fab testing.circle.load_cache
        - fab testing.circle.save_cache
        - fab testing.app.deploy
        - fab testing.infrastructure.up && sleep 5

test:
    override:
        - fab testing.qa.phpspec
        - sudo lxc-attach -n "$(docker inspect --format '{{.Id}}' capcotest_application_1)" -- /bin/bash -c -l 'cd /var/www/ && su capco -c "curl --retry 10 --retry-delay 5 -v http://elasticsearch:9200"'
        - fab testing.qa.behat:fast_failure=false
        - fab testing.qa.checkcs
        - fab testing.qa.lint
        - fab testing.infrastructure.logs

deployment:
    preprod:
        branch: develop
        commands:
            - "ssh capco@***REMOVED*** 'cd CapCollectif-DeploymentTools && fab deploy:preprod'"
