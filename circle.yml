machine:
    services:
        - docker

dependencies:
    cache_directories:
        - ~/docker
        - bower_components
        - node_modules
        - ~/.composer
        - ~/.bower
    override:
        - mkdir -p $CIRCLE_TEST_REPORTS/junit/
        - pip install -q -r requirements.txt
        - fab testing.circle.fix_environment_variables_with_lxc
        - fab testing.circle.load_cache
        - fab testing.circle.save_cache
        - fab testing.infrastructure.up
        - fab testing.app.deploy:environment=test
        - fab testing.qa.save_fixtures_image

test:
    override:
        - fab testing.qa.phpspec
        - fab testing.qa.mocha
        - fab testing.qa.behat:fast_failure=false,profile=api,parallel=true
        - fab testing.qa.behat:fast_failure=false,profile=commands,parallel=true
        - fab testing.qa.behat:fast_failure=false,profile=frontend,parallel=true
        - fab testing.qa.behat:fast_failure=false,profile=javascript
        - fab testing.qa.checkcs
    post:
        - docker ps
        - docker stop $(docker ps -a -q)
        - fab testing.circle.save_logs

deployment:
    preprod:
        branch: develop
        commands:
            - "ssh capco@***REMOVED*** 'cd CapCollectif-DeploymentTools && fab deploy:preprod'"
