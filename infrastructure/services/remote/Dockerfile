FROM node:11-slim AS node

FROM debian:stretch AS base

LABEL maintainer "Cap collectif <tech@cap-collectif.com>"

ARG APP_VERSION="latest"

# Install basic
RUN set -x \
    && DEBIAN_FRONTEND=noninteractive apt-get update && \
    apt-get install -y -qq --fix-missing --no-install-recommends \
        adduser \
        ca-certificates \
        apt-transport-https \
        build-essential \
        bzip2 \
        cron \
        curl \
        git \
        imagemagick \
        libmagickwand-dev \
        locales \
        pkg-config \
        runit \
        wget \
        libicu-dev \
        sqlite \
        software-properties-common \
        locales \
        gnupg2 \
        dirmngr \
    && \
    localedef -i en_US -c -f UTF-8 -A /usr/share/locale/locale.alias en_US.UTF-8 && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*

ENV LANG C.UTF-8

# Install php7
RUN wget -O- https://packages.sury.org/php/apt.gpg | apt-key add - && \
    echo "deb https://packages.sury.org/php/ stretch main" > /etc/apt/sources.list.d/php.list && \
    DEBIAN_FRONTEND=noninteractive apt-get update && \
    apt-get install -y -qq \
        php-apcu \
        php7.4-apcu \
        php7.4-apc \
        php7.4-cli \
        php7.4-mbstring \
        php7.4-common \
        php7.4-curl \
        php7.4-dev \
        php7.4-fpm \
        php7.4-gd \
        php7.4-imagick \
        php7.4-intl \
        php7.4-json \
        php7.4-mysql \
        php7.4-opcache \
        php7.4-redis \
        php7.4-xsl \
        php7.4-zip \
        php7.4-xml \
        php-sqlite3\
        php-amqp \
    && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*

RUN echo "extension=apcu.so" > /etc/php/7.4/php.ini
RUN echo "apc.enable_cli=1" > /etc/php/7.4/php.ini
RUN echo "apc.enable=1" > /etc/php/7.4//php.ini

# Install gosu binary (needs wget and ca-certificates).
ENV GOSU_VERSION 1.10
RUN set -ex; \
	dpkgArch="$(dpkg --print-architecture | awk -F- '{ print $NF }')"; \
	wget -O /usr/local/bin/gosu "https://github.com/tianon/gosu/releases/download/$GOSU_VERSION/gosu-$dpkgArch"; \
	wget -O /usr/local/bin/gosu.asc "https://github.com/tianon/gosu/releases/download/$GOSU_VERSION/gosu-$dpkgArch.asc"; \
	chmod +x /usr/local/bin/gosu; \
    # verify that the binary works
	gosu nobody true

# Install fake user 1000
RUN addgroup --gid=1000 capco && \
    adduser --system --uid=1000 --home /home/capco --shell /bin/bash capco

# Install composer
RUN curl -o /tmp/composer-setup.php https://getcomposer.org/installer \
    && curl -o /tmp/composer-setup.sig https://composer.github.io/installer.sig \
    && php -r "if (hash('SHA384', file_get_contents('/tmp/composer-setup.php')) !== trim(file_get_contents('/tmp/composer-setup.sig'))) { unlink('/tmp/composer-setup.php'); echo 'Invalid installer' . PHP_EOL; exit(1); }" \
    && php /tmp/composer-setup.php --version=1.10.1 --no-ansi --install-dir=/usr/local/bin --filename=composer --snapshot \
    && rm -f /tmp/composer-setup.*

# Parallel composer install
# RUN gosu capco composer global require hirak/prestissimo --prefer-dist --no-progress --classmap-authoritative

# Install nginx
RUN wget -O- https://nginx.org/keys/nginx_signing.key | apt-key add - && \
    echo "deb http://nginx.org/packages/mainline/debian/ stretch nginx" > /etc/apt/sources.list.d/nginx.list && \
    apt-get update && \
    apt-get install -y -qq --no-install-recommends \
        nginx \
    && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*

# Install redis
RUN echo "deb http://packages.dotdeb.org stretch all" > /etc/apt/sources.list.d/dotdeb.list && \
    echo "deb-src http://packages.dotdeb.org stretch all" >> /etc/apt/sources.list.d/dotdeb.list && \
    wget http://www.dotdeb.org/dotdeb.gpg -O- -q | apt-key add - && \
    apt-get update && \
    apt-get install -y -qq --no-install-recommends \
        redis-server \
    && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*&& \
    sed -i 's/^\(bind .*\)$/# \1/' /etc/redis/redis.conf && \
    sed -i 's/^\(daemonize .*\)$/# \1/' /etc/redis/redis.conf && \
    sed -i 's/^\(dir .*\)$/# \1\ndir \/data/' /etc/redis/redis.conf && \
    sed -i 's/^\(logfile .*\)$/# \1/' /etc/redis/redis.conf

# Install java
RUN apt-get update && apt-get install -y openjdk-8-jdk-headless net-tools && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# Install ES
ENV ES_VERSION 5.6.13
RUN cd / && \
    wget https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-$ES_VERSION.tar.gz && \
    tar -xzf elasticsearch-$ES_VERSION.tar.gz && \
    rm -f elasticsearch-$ES_VERSION.tar.gz && \
    mv /elasticsearch-$ES_VERSION /etc/elasticsearch
RUN /etc/elasticsearch/bin/elasticsearch-plugin install --batch analysis-icu

# Install rabbitmq
ENV RABBITMQ_VERSION_DEB=3.6.16-2
RUN echo 'deb https://dl.bintray.com/rabbitmq/debian stretch main erlang-20.x' | tee /etc/apt/sources.list.d/bintray.rabbitmq.list && \
    wget -O- https://github.com/rabbitmq/signing-keys/releases/download/2.0/rabbitmq-release-signing-key.asc | apt-key add - && \
    apt-get update && \
    DEBIAN_FRONTEND=noninteractive apt-get install -y rabbitmq-server=$RABBITMQ_VERSION_DEB && \
    rm -rf /var/lib/apt/lists/* && \
    rabbitmq-plugins enable rabbitmq_management

# Install mariadb
RUN set -x \
    && apt-key adv --recv-keys --no-tty --keyserver keyserver.ubuntu.com 0xF1656F24C74CD1D8 \
    && add-apt-repository 'deb [arch=amd64,i386,ppc64el] http://mariadb.mirrors.ovh.net/MariaDB/repo/10.1/debian stretch main' \
    && apt-get update \
    && DEBIAN_FRONTEND=noninteractive apt-get install mariadb-server -y -qq \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*

# Install varnish
RUN apt-get update -y && \
	    apt-get install -y build-essential automake libtool curl git python-docutils && \
	    curl -s https://packagecloud.io/install/repositories/varnishcache/varnish60/script.deb.sh | bash && \
	    apt-get install -y varnish-dev && \
	    git clone https://github.com/varnish/varnish-modules.git /tmp/vm && \
	    cd /tmp/vm && \
	    # Varnish dev team are currently working on a new version for varnish-modules on master branch.
	    # This commit is a reference to before the starting of varnish dev team's work.
	    git checkout 0d555b627333cd9190a40870f380ace5664f6d0d && \
	    ./bootstrap && \
	    ./configure && \
	    make && \
	    make install

# Install Supervisor
RUN apt-get update && \
    apt-get install -y python-pip python-setuptools --no-install-recommends && \
    easy_install supervisor && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*

# NewRelic PHP Probe
RUN wget -O - https://download.newrelic.com/548C16BF.gpg | apt-key add - && \
    echo 'deb http://apt.newrelic.com/debian/ newrelic non-free' | tee /etc/apt/sources.list.d/newrelic.list && \
    apt-get update && \
    DEBIAN_FRONTEND=noninteractive apt-get install newrelic-php5 -y --no-install-recommends && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*

# Move mysql elsewhere because /var/lib/mysql will be a volume after build (see mysql/run)
RUN mv /var/lib/mysql /var/lib/mysql_save

# Service
COPY infrastructure/services/remote/mysql/run                  /etc/service/mysql/run
COPY infrastructure/services/remote/nginx/run                  /etc/service/nginx/run
COPY infrastructure/services/remote/redis/run                  /etc/service/redis/run
COPY infrastructure/services/remote/cron/run                   /etc/service/cron/run
COPY infrastructure/services/remote/elasticsearch/run          /etc/service/elasticsearch/run
COPY infrastructure/services/remote/varnish/run                /etc/service/varnish/run
COPY infrastructure/services/remote/rabbitmq/run               /etc/service/rabbitmq/run
#COPY infrastructure/services/remote/nodejs/run                 /etc/service/nodejs/run
COPY infrastructure/services/remote/supervisord/run            /etc/service/supervisord/run
COPY infrastructure/services/remote/php-fpm/run                /etc/service/php-fpm/run
COPY infrastructure/services/remote/redirectionio/run          /etc/service/redirectionio/run

# Configuration
COPY infrastructure/services/remote/mysql/capco.cnf                /etc/mysql/conf.d/capco.cnf
COPY infrastructure/services/remote/nginx/nginx.conf               /etc/nginx/nginx.conf
COPY infrastructure/services/remote/php-fpm/capco.ini              /etc/php/7.4/fpm/conf.d/capco.ini
COPY infrastructure/services/remote/php-fpm/capco.ini              /etc/php/7.4/cli/conf.d/capco.ini
COPY infrastructure/services/remote/php-fpm/fpm.conf               /etc/service/php-fpm/fpm.conf
COPY infrastructure/services/remote/cron/crontab                   /etc/cron.d/crontab
COPY infrastructure/services/remote/elasticsearch/capco.yml        /etc/elasticsearch/config/elasticsearch.yml
COPY infrastructure/services/remote/varnish/capco.vcl              /etc/varnish/capco.vcl
COPY infrastructure/services/remote/rabbitmq/rabbitmq.config         /etc/rabbitmq/rabbitmq.config
COPY infrastructure/services/remote/logrotate/mysql-slow-logs      /etc/logrotate.d/mysql-slow-logs
COPY infrastructure/services/remote/supervisord/                   /etc/supervisord
COPY infrastructure/services/remote/redirectionio/agent.yml        /etc/redirectionio/agent.yml

# Cache storage for rules
VOLUME /var/lib/redirectionio

# Binaries
COPY infrastructure/services/remote/rabbitmq/rabbitmqadmin     /usr/local/bin/rabbitmqadmin

# Daemons
COPY infrastructure/services/remote/php-fpm/populate_elasticsearch_index /etc/service/php-fpm/populate_elasticsearch_index

ENV SYMFONY_ENVIRONMENT prod
ENV SYMFONY_DEBUG false
ENV SYMFONY_APP_VERSION=$APP_VERSION

# make pam_loginuid.so optional for cron
# see https://github.com/docker/docker/issues/5663#issuecomment-42550548
RUN sed --regexp-extended --in-place \
    's/^session\s+required\s+pam_loginuid.so$/session optional pam_loginuid.so/' \
    /etc/pam.d/cron

# Create Working dir with good rights
RUN mkdir -p /var/www \
    && chown capco:capco /var/www \
    && chmod 0644 /etc/cron.d/crontab \
    && find /etc/service/ -name "run" -exec chmod +x {} \;
#RedirectionIO
WORKDIR /usr/local/bin/
RUN wget https://packages.redirection.io/dist/redirectionio-agent-latest_any_amd64.tar.gz
RUN tar -xzvf redirectionio-agent-latest_any_amd64.tar.gz
WORKDIR /var/www

# NodeJS and Yarn
COPY --from=node /usr/local/bin/node /usr/local/bin/node
COPY --from=node /usr/local/include/node /usr/local/include/node
COPY --from=node /usr/local/lib/node_modules /usr/local/lib/node_modules
RUN ln -s /usr/local/bin/node /usr/local/bin/nodejs && \
    ln -s /usr/local/lib/node_modules/npm/bin/npm-cli.js /usr/local/bin/npm

ENV YARN_VERSION 1.16.0
RUN curl -fSLO --compressed "https://yarnpkg.com/downloads/$YARN_VERSION/yarn-v$YARN_VERSION.tar.gz" \
    && tar -xzf yarn-v$YARN_VERSION.tar.gz -C /opt/ \
    && ln -snf /opt/yarn-v$YARN_VERSION/bin/yarn /usr/local/bin/yarn \
    && ln -snf /opt/yarn-v$YARN_VERSION/bin/yarnpkg /usr/local/bin/yarnpkg \
    && rm yarn-v$YARN_VERSION.tar.gz

# Download PHP dependencies
COPY composer.json composer.lock ./

# Will only install bundles that have changed since building the base image
RUN gosu capco composer install --no-dev --prefer-dist --no-interaction --ignore-platform-reqs --no-progress

# Then add usefull source code
COPY bin /var/www/bin
COPY translations /var/www/translations
COPY public /var/www/public
COPY app /var/www/app
COPY src /var/www/src
COPY assets /var/www/assets
COPY frontend /var/www/frontend
COPY templates /var/www/templates
COPY config /var/www/config
COPY fixtures /var/www/fixtures

# Maybe chown before copy will be faster
RUN mkdir -m 755 -p translations var public/bundles src/Capco/AppBundle/GraphQL/__generated__ \
    && chown -R capco:capco . \
    && mkdir -p var/cache/prod \
    && chown -R capco:capco var \
    && chmod -R 777 var

# /!\
# /!\ Beyond this step nothing is cached /!\
# /!\

# Build autoloader and initialize Symfony
RUN rm -rf vendor/simplesamlphp/simplesamlphp/config/* \
    && rm -rf vendor/simplesamlphp/simplesamlphp/metadata/* \
    && rm -rf vendor/simplesamlphp/simplesamlphp/cert \
    && cp -r app/config/simplesamlphp /var/www/vendor/simplesamlphp \
    && gosu capco php bin/console graphql:compile --env=${SYMFONY_ENVIRONMENT} \
    && gosu capco composer dump-autoload --no-dev --optimize --apcu \
    && gosu capco php -d memory_limit=-1 bin/console cache:warmup --env=$SYMFONY_ENVIRONMENT --no-interaction \
    && gosu capco php bin/console assets:install public --symlink --env=${SYMFONY_ENVIRONMENT} --no-interaction

# Install crontab just to check if it's valid.
RUN set -ex; \
    crontab -uroot /etc/cron.d/crontab

CMD ["/usr/bin/runsvdir", "-P", "/etc/service"]
