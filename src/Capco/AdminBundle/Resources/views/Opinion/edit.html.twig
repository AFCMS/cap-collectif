{% extends 'SonataAdminBundle:CRUD:base_edit.html.twig' %}

{% block javascripts %}
    {{ parent() }}
    <script type="text/javascript">

        $(document).ready(function() {

            updateAllowedAppendices();
            $(document).on('change', ".opinion-type-js" , updateAllowedAppendices);
            $('[id^=sonata-ba-field-container-][id$=_appendices]').on('sonata.add_element', updateAllowedAppendices);

            function updateAllowedAppendices() {
                var opinionTypeSelect = $(".opinion-type-js");
                var opinionTypeId = $("option:selected", opinionTypeSelect).val();

                var url = "{{ url('capco_admin_get_allowed_appendices') }}";
                $.get(url, {'opinionTypeId': opinionTypeId}, function(data){

                    if (data.length > 0) {
                        $('select.appendix-type-js').each(function() {
                            var select = $(this);
                            // Save selected value
                            var prevSelected = $("option:selected", select).val();
                            console.log(prevSelected);
                            // Empty and reload select
                            select.empty();
                            data.map(function (option) {
                                var option = $('<option>').text(option.title).attr('value', option.id);
                                select.append(option);
                            });
                            // Put back selected option if possible
                            if ($('option[value='+prevSelected+']', select)) {
                                console.log('found');
                                $('option[value='+prevSelected+']', select).prop('selected', true);
                            }

                        });
                        $(".appendices-block-js").removeClass('hidden');
                    } else if (!$(".appendices-block-js").hasClass('hidden')) {
                        $(".appendices-block-js").addClass('hidden');
                    }

                });
            }
        });
    </script>
{% endblock %}
