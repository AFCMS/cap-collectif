imports:
    - { resource: services/listeners.yml }
    - { resource: services/repositories.yml }
    - { resource: services/resolvers.yml }
    - { resource: services/twig.yml }
    - { resource: services/validators.yml }

parameters:
  capco.notify.manager.class: Capco\AppBundle\Manager\Notify
  capco.toggle.manager.class: Capco\AppBundle\Toggle\Manager
  capco.help_extension.class: Capco\AppBundle\Form\Extension\HelpExtension
  capco.vote.resolver.class: Capco\AppBundle\Resolver\VoteResolver
  capco.twig.vote.class: Capco\AppBundle\Twig\VoteExtension
  capco.end_after_start.validator.class: Capco\AppBundle\Validator\Constraints\EndAfterStartValidator
  traits:
    selflinkable:
      interfaces:
        - Capco\AppBundle\Entity\Interfaces\SelfLinkableInterface

services:
  import.csvtoarray:
    class: Capco\AppBundle\Helper\ConvertCsvToArray

  mapping.listener:
    class: Capco\AppBundle\EventListener\DynamicRelationSubscriber
    tags:
      - { name: doctrine.event_listener, event: loadClassMetadata }
    arguments: ['%traits%']

  capco.site_parameter.repository:
    class: %capco.site_parameter.repository.class%
    factory_service: doctrine.orm.default_entity_manager
    factory_method: getRepository
    arguments:
      - Capco\AppBundle\Entity\SiteParameter

  capco.site_parameter.resolver:
    class: %capco.site_parameter.resolver.class%
    arguments:
      - @capco.site_parameter.repository
      - @logger

  capco.twig.site_parameter:
    class: %capco.twig_extension.site_parameter.class%
    arguments: [ @capco.site_parameter.resolver ]
    tags:
      - { name: twig.extension }

  ## Site paramèters for Image
  capco.site_image.repository:
    class: %capco.site_image.repository.class%
    factory_service: doctrine.orm.default_entity_manager
    factory_method: getRepository
    arguments:
      - Capco\AppBundle\Entity\SiteImage

  capco.site_image.resolver:
    class: %capco.site_image.resolver.class%
    arguments:
      - @capco.site_image.repository
      - @logger

  capco.twig.site_image:
    class: %capco.twig_extension.site_image.class%
    arguments: [ @capco.site_image.resolver ]
    tags:
      - { name: twig.extension }

  # default avatar
  capco.twig.default_avatar:
    class: %capco.twig.default_avatar.class%
    arguments:
      - @capco.site_image.resolver
    tags:
      - { name: twig.extension }

  ## Site paramèters for colors
  capco.site_color.repository:
    class: %capco.site_color.repository.class%
    factory_service: doctrine.orm.default_entity_manager
    factory_method: getRepository
    arguments:
        - Capco\AppBundle\Entity\SiteColor

  capco.site_color.resolver:
    class: %capco.site_color.resolver.class%
    arguments:
      - @capco.site_color.repository
      - @logger

  capco.twig.site_color:
    class: %capco.twig_extension.site_color.class%
    arguments: [ @capco.site_color.resolver ]
    tags:
      - { name: twig.extension }

  ## Menu URL
  capco.twig.menu_url:
    class: %capco.twig_extension.menu_url.class%
    arguments: [ @router, @validator ]
    tags:
      - { name: twig.extension }

  capco.form.type_extension.media:
    class: Capco\AppBundle\Form\Extension\MediaTypeExtension
    tags:
      - { name: form.type_extension, alias: sonata_media_type }

  ## Service Notify - send mail
  capco.notify_manager:
    class:     %capco.notify.manager.class%
    arguments: [@mailer, @swiftmailer.mailer.service, @templating, @translator, @capco.site_parameter.resolver, @router, @capco.url.resolver, {confirmation.template: %fos_user.registration.confirmation.template%, resetting.template: %fos_user.resetting.email.template%}]

  ## Toggle
  capco.toggle.manager:
    class:     %capco.toggle.manager.class%
    arguments: [@qandidate.toggle.manager, @qandidate.toggle.user_context_factory, "%redis_prefix%" ]

  capco.event.helper:
    class: Capco\AppBundle\Helper\EventHelper

  capco.idea.helper:
    class: Capco\AppBundle\Helper\IdeaHelper

  capco.help_extension:
    class: %capco.help_extension.class%
    tags:
      - { name: form.type_extension, alias: text }

  capco.vote.subscriber:
    class: Capco\AppBundle\EventListener\VoteSubscriber
    arguments: [@doctrine.orm.entity_manager]
    tags:
      - { name: "kernel.event_subscriber" }

  capco.comment.subscriber:
    class: Capco\AppBundle\EventListener\CommentSubscriber
    tags:
      - { name: "kernel.event_subscriber" }

  capco.synthesis.log_manager:
    class: Capco\AppBundle\Manager\LogManager
    arguments: [@translator, @fos_user.user_manager, @doctrine.orm.entity_manager]


  capco.synthesis.synthesis_handler:
    class: Capco\AppBundle\Synthesis\Handler\SynthesisHandler
    arguments: [@doctrine.orm.entity_manager, @capco.synthesis.consultation_step_extractor]

  capco.synthesis.synthesis_element_handler:
    class: Capco\AppBundle\Synthesis\Handler\SynthesisElementHandler
    arguments: [@doctrine.orm.entity_manager, @capco.synthesis.log_manager]

  capco.synthesis.consultation_step_extractor:
    class: Capco\AppBundle\Synthesis\Extractor\ConsultationStepExtractor
    arguments: [@doctrine.orm.entity_manager, @translator, @router, @capco.opinion_types.resolver]
