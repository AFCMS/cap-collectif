services:
    capco.elasticsearch.client:
        class: Elastica\Client
        arguments:
            -
                connections:
                    - { host: '%elasticsearch_host%', port: '9200' }
            - ~
            - "@monolog.logger"

    capco.elasticsearch.index_builder:
        class: Capco\AppBundle\Elasticsearch\IndexBuilder
        arguments:
            - '@capco.elasticsearch.client'

    capco.elasticsearch.indexer:
        class: Capco\AppBundle\Elasticsearch\Indexer
        arguments:
            - '@doctrine'
            - '@serializer'
            - '@capco.elasticsearch.index'

    capco.elasticsearch.index:
        class: Elastica\Index
        factory: ['@capco.elasticsearch.index_builder', getLiveSearchIndex]

    capco.elasticsearch.elastica_to_doctrine_transformer:
        class: Capco\AppBundle\Elasticsearch\ElasticaToDoctrineTransformer
        arguments:
            - '@doctrine'
            - '@capco.elasticsearch.indexer'
        calls:
            - ['setPropertyAccessor', ['@property_accessor']]

    capco.elasticsearch.listener:
        class: Capco\AppBundle\Elasticsearch\DoctrineUpdateListener
        arguments:
          - '@swarrot.publisher'
        tags:
          - { name: doctrine.event_subscriber, connection: default }

    elasticsearch_indexation.processor:
        class: Capco\AppBundle\Elasticsearch\IndexationProcessor
        arguments:
            - '@capco.elasticsearch.indexer'
            - '@logger'
