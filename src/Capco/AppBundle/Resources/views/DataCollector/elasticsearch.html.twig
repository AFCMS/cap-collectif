{% extends 'WebProfilerBundle:Profiler:layout.html.twig' %}

{% block toolbar %}
    {% set profiler_markup_version = profiler_markup_version|default(1) %}

    {% set icon %}
        <span class="icon">{{ include('@CapcoApp/DataCollector/elasticsearch_logo.svg.twig') }}</span>
        <span class="sf-toolbar-value">{{ collector.queriesCount }}</span>
        {% if collector.queriesCount > 0 %}
            <span class="sf-toolbar-info-piece-additional-detail">
                    <span class="sf-toolbar-label">in</span>
                    <span class="sf-toolbar-value">{{ '%0.2f'|format(collector.time) }}</span>
                    <span class="sf-toolbar-label">ms</span>
                </span>
        {% endif %}
    {% endset %}
    {% set text %}
        <div class="sf-toolbar-info-piece">
            <b>Queries</b>
            <span class="sf-toolbar-status">{{ collector.queriesCount }}</span>
        </div>
        <div class="sf-toolbar-info-piece">
            <b>Query Time</b>
            <span>{{ '%0.2f'|format(collector.time) }} ms</span>
        </div>
    {% endset %}
    {% include 'WebProfilerBundle:Profiler:toolbar_item.html.twig' with { 'link': profiler_url } %}
{% endblock %}

{% block menu %}
    <span class="label {{ collector.queriesCount ? '' : 'disabled' }}">
        <span class="icon">{{ include('@CapcoApp/DataCollector/elasticsearch_logo.svg.twig') }}</span>
        <strong>Elastica</strong>
    </span>
{% endblock %}

{% block panel %}
    <h2>Queries</h2>

    {% if not collector.queriesCount %}
        <div class="empty">
            <p>No queries were performed.</p>
        </div>
    {% else %}
        <ul class="alt">
            {% for key, query in collector.queries %}
                <li class="{{ cycle(['odd', 'even'], loop.index) }}">
                    <strong>Path</strong>: {{ query.path }}<br/>
                    <strong>Query</strong>: {{ query.queryString|url_encode }}<br/>
                    <strong>Method</strong>: {{ query.method }}
                    <small>({{ query.connection.transport }} on {{ query.connection.host }}:{{ query.connection.port }}
                        )
                    </small>
                    <div>
                        <code>{{ query.data|json_encode }}</code>
                    </div>
                    <strong>Query time</strong>: {{ query.engineMS }} ms<br/>
                    <strong>Item count</strong>: {{ query.itemCount }}<br/>
                    <small>
                        <strong>Time</strong>: {{ '%0.2f'|format(query.executionMS * 1000) }} ms
                    </small>
                    {% if query.connection.transport in ['Http', 'Https'] %}{# cURL support only HTTP #}
                        <a href="#elastica_curl_query_{{ key }}" onclick="return toggle_details(this);"
                           style="text-decoration: none;" title="Get the cURL repeatable query">
                            <img alt="+" src="{{ asset('bundles/framework/images/blue_picto_more.gif') }}"
                                 style="display: inline; width: 12px; height: 12px; vertical-align: bottom;"/>
                            <img alt="-" src="{{ asset('bundles/framework/images/blue_picto_less.gif') }}"
                                 style="display: none; width: 12px; height: 12px; vertical-align: bottom;"/>
                            <small>Display cURL query</small>
                        </a>
                    {% endif %}
                    {% if query.backtrace is defined %}
                        <a href="#elastica_query_backtrace_{{ key }}" onclick="return toggle_details(this);"
                           style="text-decoration: none;" title="Display backtrace of query execution">
                            <img alt="+" src="{{ asset('bundles/framework/images/blue_picto_more.gif') }}"
                                 style="display: inline; width: 12px; height: 12px; vertical-align: bottom;"/>
                            <img alt="-" src="{{ asset('bundles/framework/images/blue_picto_less.gif') }}"
                                 style="display: none; width: 12px; height: 12px; vertical-align: bottom;"/>
                            <small>Display query backtrace</small>
                        </a>
                    {% endif %}

                    {% if query.connection.transport in ['Http', 'Https'] %}{# cURL support only HTTP #}
                        <div style="display: none;" id="elastica_curl_query_{{ key }}">
                            <code>curl -X{{ query.method }} '{{ query.connection.transport|lower }}
                                ://{{ query.connection.host }}:{{ query.connection.port }}
                                /{{ query.path }}{% if query.queryString|length %}?{{ query.queryString|url_encode }}{% endif %}
                                ' -d '{{ query.data|json_encode }}'</code>
                        </div>
                    {% endif %}
                    {% if query.backtrace is defined %}
                        <div style="display: none;" id="elastica_query_backtrace_{{ key }}">
                            <code>
                                <pre>{{ query.backtrace }}</pre>
                            </code>
                        </div>
                    {% endif %}
                </li>
            {% endfor %}
        </ul>

        <script type="text/javascript">//<![CDATA[
            function toggle_details(link) {
                "use strict";

                var sections = link.children;

                if (sections[0].style.display != 'none') {
                    sections[0].style.display = 'none';
                    sections[1].style.display = 'inline';

                    document.getElementById(link.hash.replace("#", "")).style.display = 'block';
                } else {
                    sections[0].style.display = 'inline';
                    sections[1].style.display = 'none';

                    document.getElementById(link.hash.replace("#", "")).style.display = 'none';
                }

                return false;
            }
        </script>
    {% endif %}
{% endblock %}
