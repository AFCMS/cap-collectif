{% extends '@CapcoApp/Event/index.html.twig' %}
{% block stylesheets %}
    {{ parent() }}
    <link href="{{ asset('js/fancybox/jquery.fancybox.css') }}" rel="stylesheet">
{% endblock %}

{% block canonical_link %}{{ url('app_event_show', {'slug': event.slug}) }}{% endblock %}

{% block title %}
    {{ parent() }} - {{ event.title }}
{% endblock %}

{% block jumbotron %}
{% endblock %}

{% block body %}
    <div id="sidebar-container">
        <div class="row">
            <div class="col-xs-12  {% if event|capco_event_registration_possible %}col-sm-9{% endif %}">
                <div class="container  container--custom">
                    <h1 class="h1"> {{ event.title }}</h1>
                    <div class="media">
                        {%  set avatar = event.Author.Media|capco_default_avatar %}
                        {% if avatar != null %}
                            <a class="pull-left" href="{{ path('capco_user_profile_show_all', {'slug': event.Author.slug}) }}">
                                {% thumbnail avatar, 'avatar' with {'title': event.Author.username, 'alt': event.Author.username, 'class': 'media-object img-circle'} %}
                            </a>
                        {% else %}
                            <a class="pull-left" href="{{ path('capco_user_profile_show_all', {'slug': event.Author.slug}) }}">
                                <svg version="1.1" id="Calque_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="45px" height="45px" viewBox="0 0 200 200" enable-background="new 0 0 200 200" xml:space="preserve"><circle fill="{{ capco_site_color_value('color.section.bg')  }}" cx="100" cy="100" r="97.617"/><g><path fill="none" stroke="#FFFFFF" stroke-width="3" stroke-linejoin="round" stroke-miterlimit="10" d="M100,160.011h68.011c0,0,0-12.163-5.916-23.993c-4.41-8.819-22.024-14.039-45.683-22.908V95.367c0,0,7.239-6.661,7.239-18.49c2.959,0,5.916-11.826,0-14.785c0-1.754,7.927-16.569,5.916-26.613c-2.957-14.786-44.353-14.786-47.309-2.955c-17.742,0-5.915,27.169-5.915,29.568c-5.913,2.959-2.957,14.785,0,14.785c0,11.829,7.238,17.473,7.238,17.473v18.759c-23.655,8.875-41.273,14.089-45.682,22.908c-5.911,11.83-5.911,23.993-5.911,23.993H100z"/></g></svg>
                            </a>
                        {% endif %}
                        <div class="media-body">
                            <p class="media--aligned  excerpt">
                                <a href="{{ path('capco_user_profile_show_all', {'slug': event.Author.slug}) }}">{{ event.Author.username }}</a>
                                {% if is_feature_enabled('themes') and event.themes | length > 0 %}
                                    {{ 'event.show.in_theme'|trans({}, 'CapcoAppBundle') }}
                                    {% for theme in event.themes %}
                                        {% if theme.canDisplay %}
                                            <a href="{{ path('app_theme_show', {'slug': theme.slug}) }}">{{ theme.title }}</a>{% if loop.revindex0 == '1' %} {{ 'event.and' | trans({}, 'CapcoAppBundle') }}{% elseif loop.revindex0 >= '2' %}, {% endif %}{% endif %}{% endfor %},
                                {% endif %}
                                {{ 'event.show.on_date'|trans({'%date%': event.createdAt | localizeddate('long', 'none') }, 'CapcoAppBundle') }}
                                {% if capco_comment_can_show(event) %}
                                    | {% transchoice event.commentsCount with {'%count%': event.commentsCount} from 'CapcoAppBundle' %}
                                    event.show.comments
                                    {% endtranschoice %}
                                {% endif %}
                                {% if event.registrations|length > 0 %}
                                    | {% transchoice event.registrations|length with {'%count%': event.registrations|length} from 'CapcoAppBundle' %}
                                    event_registration.listing.count
                                    {% endtranschoice %}
                                {% endif %}
                        </div>
                    </div>
                </div>

                <div class="container  container--custom">

                    <ul class="event__meta  block">
                        <li class="excerpt"><i class="cap cap-calendar-1"></i>
                            {% if event.startAt == event.endAt %}
                                {{ 'event.on_date'|trans({'%date%': (event.startAt | localizeddate('long', 'none', app.request.locale))}, 'CapcoAppBundle') }}
                            {% else %}
                                {{ 'event.between_dates'|trans({'%start%': (event.startAt | localizeddate('long', 'none', app.request.locale)), '%end%': (event.endAt | localizeddate('long', 'none', app.request.locale))}, 'CapcoAppBundle') }}
                            {% endif %}
                        </li>
                        {% if event.address or event.zipCode or event.city %}
                        <li class="excerpt">
                            <address>
                                <i class="cap cap-marker-1  excerpt"></i>
                                {{ event.address }}, {{ event.zipCode }} {{ event.city }}{% if event.country %}, {{ event.country }}{% endif %} <br/>
                            </address>
                        </li>
                        {% endif %}
                    </ul>

                    {% if event.Media %}
                        {% thumbnail event.Media, 'idea' with {'class': 'block  img-responsive'} %}
                    {% endif %}

                    <div class="block">
                        {{ event.body|raw| jolitypo() }}
                    </div>

                    {% if event.lat and event.lng %}
                        <div class="event__map  map-canvas  block" data-lat="{{ event.lat }}" data-lng="{{ event.lng }}"></div>
                    {% endif %}

                    {% if event.consultations | length > 0 %}
                        <div class="block">
                            <p>
                                {% transchoice event.consultations | length from 'CapcoAppBundle' %}
                                    event.show.consultations.title
                                {% endtranschoice %}
                            </p>
                            <ul>
                                {% for consultation in event.consultations %}
                                    <li><a href="{{ consultation | capco_first_step_link }}">{{ consultation.title }}</a></li>
                                {% endfor %}
                            </ul>
                        </div>
                    {% endif %}

                    {% if event.link %}
                        <a class="btn  btn-primary  external-link" href="{{ event.link }}" class="external-link">{{ 'event.link_button'|trans({}, 'CapcoAppBundle') }}</a>
                    {% endif %}

                    {{ sonata_block_render({'type': 'capco.block.service.share_button'}, {
                        'url': url('app_event_show', {'slug': event.slug}),
                        'title': event.title,
                    }) }}
                </div>

                {% if event.registrations|length > 0 %}
                    <div class="container  container--custom">
                        <h2>{{ 'event_registration.listing.title'|trans({}, 'CapcoAppBundle') }}</h2>
                        {% set limit = 6 %}
                        {% include 'CapcoAppBundle:Event:event_registrations.html.twig' with {'event': event, 'limit': limit} only %}
                        {% if event.registrations|length > limit %}
                            <button type="button" class="btn btn-primary btn--outline" data-toggle="modal" data-target="#eventRegistrationModal">
                                {{ 'event_registration.listing.see_all'|trans({}, 'CapcoAppBundle') }}
                            </button>
                        {% endif %}
                    </div>

                    <!-- Modal -->
                    <div class="modal fade" id="eventRegistrationModal" tabindex="-1" role="dialog" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                                    <h4 class="modal-title">{{ 'event_registration.listing.title_all'|trans({}, 'CapcoAppBundle') }}</h4>
                                </div>
                                <div class="modal-body">
                                    {% include 'CapcoAppBundle:Event:event_registrations.html.twig' with {'event': event } only %}
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-primary" data-dismiss="modal">Fermer</button>
                                </div>
                            </div>
                        </div>
                    </div>

                {% endif %}

                {% if capco_comment_can_add(event) or (capco_comment_can_show(event) and event.commentsCount > 0) %}
                    <div class="container  container--custom">
                        {% if capco_comment_can_show(event) and event.commentsCount > 0 %}
                            {{ render(controller('CapcoAppBundle:Comment:showComments', {'object': event})) }}
                        {% endif %}

                        {% if capco_comment_can_add(event) %}
                            {{ render(controller('CapcoAppBundle:Comment:create', {'objectId': event.id, 'objectType': event.className})) }}
                        {% endif %}
                    </div>
                {% endif %}

            </div>

            {% if event|capco_event_registration_possible %}
                <div id="sidebar-overlay"></div>
                <div class="col-xs-12  col-sm-3  sidebar" id="sidebar">
                    <div class="block block--bordered box sidebar-hideable  sidebar-hidden-small">

                        {% include 'CapcoUserBundle:Avatar:avatar.html.twig' with { 'user': app.user, 'class': 'media-object'} only %}

                        <div class="sidebar__form">
                            {{ form(form) }}
                        </div>

                        {% if app.user is null %}
                            <p class="text-center p--topped"><a href="{{ path('fos_user_security_login') }}">{{ 'event_registration.create.my_account'|trans({}, 'CapcoAppBundle') }}</a></p>
                        {% endif %}

                        <button type="button" class="sidebar-toggle sidebar-hidden-large  btn  btn-default  btn-block">{{ 'event_registration.toggle.cancel'|trans({}, 'CapcoAppBundle') }}</button>
                    </div>

                    {% if event | capco_event_user_registered(app.user) %}
                        <button type="button" class="sidebar-toggle sidebar-hideable  sidebar-hidden-large  btn-danger btn-lg  btn  btn-block  btn--no-radius">{{ 'event_registration.toggle.unsubscribe'|trans({}, 'CapcoAppBundle') }}</button>
                    {% else %}
                        <button type="button" class="sidebar-toggle sidebar-hideable  sidebar-hidden-large  btn-primary btn-lg  btn  btn-block  btn--no-radius">{{ 'event_registration.toggle.subscribe'|trans({}, 'CapcoAppBundle') }}</button>
                    {% endif %}
                </div>
            {% endif %}
        </div>

    </div>

{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script src="{{ asset('js/readmore/readmore.js') }}"></script>
    <script src="https://maps.googleapis.com/maps/api/js"></script>
    <script type="text/javascript">
        $(window).on('load', function() {
            App.module.showMap('.map-canvas');
            {% if event | capco_event_registration_possible %}
                App.module.makeSidebar({
                    sidebar: '#sidebar',
                    container: '#sidebar-container',
                    hideable: '.sidebar-hideable',
                    toggle: '.sidebar-toggle',
                    overlay: '#sidebar-overlay'
                });
            {% endif %}
        });
        $('.more').readmore({
            collapsedHeight: 98,
            moreLink: '<a href="#">{{ 'comment.read_more'|trans({}, 'CapcoAppBundle') }}</a>',
            lessLink: '<a href="#">{{ 'comment.read_less'|trans({}, 'CapcoAppBundle') }}</a>'
        });
    </script>
{% endblock %}
