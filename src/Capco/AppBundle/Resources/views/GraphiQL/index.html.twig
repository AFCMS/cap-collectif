<!DOCTYPE html>
<html>
<head>
  {% block head %}
  {% block style %}
    <style>
      html, body {
        width: 100%;
        height: 100%;
        margin: 0;
        overflow: hidden;
      }
    </style>
  <link href="https://unpkg.com/graphiql@{{ versions.graphiql }}/graphiql.css" rel="stylesheet">
  {% endblock style %}
    <script src="https://unpkg.com/whatwg-fetch@{{ versions.fetch }}/fetch.js"></script>
    <script src="https://unpkg.com/react@{{ versions.react }}/dist/react.min.js"></script>
    <script src="https://unpkg.com/react-dom@{{ versions.react }}/dist/react-dom.min.js"></script>
    <script src="https://unpkg.com/graphiql@{{ versions.graphiql }}/graphiql.min.js"></script>
    <title>{% block title %}GraphiQL{% endblock title %}</title>
  {% endblock head %}
</head>
<body>
{% block body %}

  {% set isInternal = schemaName == 'internal' %}
  {% if app.user %}  
    {% set publicApiToken = publicApiKeyRepo.findPublicApiTokensByUser(app.user) is not empty ? publicApiKeyRepo.findPublicApiTokensByUser(app.user)[0] : null %}
  {% endif %}

  <div style="width: 100%; height: 100%">
    <p style="margin-left: 15px">
    {% if app.user and (isInternal or publicApiToken) %}
      <div style="margin-left: 15px">
       Signed in as <strong>{{app.user.username}}</strong>. Youâ€™re ready to explore real, live, production data!
      </div>
    {% else %}
      {% if app.user %}
        Sorry, we could not find an API key for your account <strong>{{app.user.username}}</strong>. Contact <email>coucou@cap-collectif.com</email>. Your API requests are not authenticated.
       {% else %}
        Start exploring GraphQL API queries using your account by logging in. 
       {% endif %}
    {% endif %}
      <div style="margin-left: 15px">
      {% if isInternal %}
         Hello capco dev ! You are querying <strong>Internal</strong> schema.
      {% else %}
         Schema Previews are <strong>enabled</strong> by default.
      {% endif %}
      </div>
    </p>
    <div id="graphiql-render" style="width: 100%; height: 100%; border-top: 1px solid #ddd"></div>
  </div>
  {% block body_loading %}Loading...{% endblock body_loading %}
  {% block body_script %}
    <script>
      var endpoint = {{ endpoint | json_encode | raw }}

        function graphQLFetcher(params) {
          {% block fetcher_function_body %}
          var headers

          {% block graphql_fetcher_headers %}
          headers = {
            {# Preview schema is enabled by default, maybe we should add a toggle #}
            "Accept": "application/vnd.cap-collectif.preview+json",
            "Content-Type": "application/json",
            {% if app.user and not isInternal and publicApiToken %}
              "Authorization": "Bearer {{publicApiToken.value}}",
            {% endif %}
          }
          {% endblock graphql_fetcher_headers %}

          return fetch(endpoint, {
              method: "post",
              headers: headers,
              body: JSON.stringify(params),
              credentials: 'include',
            }).then((res) => {
              {% block post_fetch %}{% endblock post_fetch %}
              return res.text()
            }).then((body) => {
            try {
              return JSON.parse(body)
            } catch (err) {
              return body
            }
          })
          {% endblock fetcher_function_body %}
        }

      ReactDOM.render(
        React.createElement(GraphiQL, {
          {% block graphiql_params %}
          fetcher: graphQLFetcher
          {% endblock graphiql_params %}
        }),
        document.getElementById('graphiql-render')
      )
    </script>
  {% endblock body_script %}
{% endblock body %}
</body>
</html>
