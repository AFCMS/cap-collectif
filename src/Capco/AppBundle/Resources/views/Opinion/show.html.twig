{% extends '@CapcoApp/Consultation/show.html.twig' %}

{% block canonical_link %}{{ url('app_consultation_show_opinion', {'consultationSlug': consultation.slug, 'opinionTypeSlug': opinionType.slug, 'opinionSlug': opinion.slug}) }}{% endblock %}

{% block title %}
    {{ parent() }} - {{ opinion.title }}
{% endblock %}

{% block jumbotron %}
{% endblock %}

{% block body %}
    <div class="container  container--custom">
        {% include '@CapcoApp/Consultation/show_title.html.twig' %}
    </div>

    <div class="container  container--custom">

        {% if consultation.isClose %}
            <div class="alert alert-info alert-dismissible  block" role="alert">
                <p><strong>{{ 'consultation.show.alert.ended.title'|trans({}, 'CapcoAppBundle') }}</strong> {{ 'consultation.show.alert.ended.text'|trans({}, 'CapcoAppBundle') }}</p>
            </div>
        {% endif %}

        {% if consultation.isFuture %}
            <div class="alert alert-info alert-dismissible  block" role="alert">
                <p><strong>{{ 'consultation.show.alert.future.title'|trans({}, 'CapcoAppBundle') }}</strong> {{ 'consultation.show.alert.future.text'|trans({'%date%': '<strong>' ~ consultation.getOpenedAt| localizeddate('long', 'none', app.request.locale) ~ '</strong>'}, 'CapcoAppBundle') | raw }}</p>
            </div>
        {% endif %}

        <div class="row">
            <div class="col-xs-12  col-sm-4  col-md-3  block--mobile">
                {% include '@CapcoApp/Consultation/show_meta.html.twig' %}
            </div>

            {% set nbVotes = (opinion.getVoteCountAll) %}
            {% set nbArguments = (opinion.argumentsCount) %}
            {% set nbSources = (opinion.sourcesCount) %}
            <div class="col-xs-12  col-sm-8  col-md-9 has-chart" id="details" data-ok="{{ opinion.voteCountOk }}" data-nok="{{ opinion.voteCountNok }}" data-mitige="{{ opinion.voteCountMitige }}" data-opinion-id="{{ opinion.id }}">
                <div class="block  block--bordered  opinion__details">
                    <div class="opinion  opinion--{{ opinion.opinionType.color }}  opinion--current">
                        <div class="opinion__header  opinion__header--centered">
                            <a class="neutral-hover  pull-left  h4" href="{% if opinion.isTrashed %}{{ path('app_consultation_show_trashed', {'consultationSlug': consultation.slug,}) }}{% else %}{{ path('app_consultation_show_opinions', {'consultationSlug': consultation.slug, 'opinionTypeSlug': opinionType.slug}) }}{% endif %}"><i class="cap cap-arrow-1"></i><span class="hidden-xs  hidden-sm"> {{ 'opinion.show.back'|trans({}, 'CapcoAppBundle') }}</span></a>
                            <h2 class="h4  opinion__header__title">{{ opinion.opinionType.slug|capitalize }} </h2>
                        </div>
                        {% include 'CapcoAppBundle:Opinion:opinion_body.html.twig' %}
                    </div>

                    <div class="opinion__description">
                        {% if(nbVotes > 0) %}
                            <div id="piechart-{{ opinion.id }}" class="opinion__chart  center-block"></div>
                        {% endif %}
                        {{ opinion.body|raw }}
                        <div class="opinion__buttons">
                            {% set opinionVoteCounts = { (opinionVoteTypes['ok']): opinion.voteCountOk, (opinionVoteTypes['nok']): opinion.voteCountNok, (opinionVoteTypes['mitige']): opinion.voteCountMitige } %}
                            {% set previousValue = null %}
                            {% if previousVote is not null %}
                                {% set previousValue = previousVote.value %}
                            {% endif %}

                            {% if opinion.canContribute %}

                                {% form_theme opinionVoteForm 'CapcoAppBundle:Form:opinion_vote.html.twig' %}
                                {{ form_start(opinionVoteForm, {'attr': {'class': 'vote-form '} }) }}
                                {{ form_errors(opinionVoteForm) }}
                                {{ form_widget(opinionVoteForm.value, {'previousType': previousValue, 'typeStyles': opinionVoteStyles}) }}
                                {{ form_rest(opinionVoteForm) }}
                                {{ form_end(opinionVoteForm) }}

                                {% if (previousVote) %}
                                    <div class="opinion__vote-group">
                                        {% set tokenRemoveVote = csrf_token('remove_opinion_vote') %}
                                        <form method="POST" style="display: inline-block;" action="{{ path('app_consultation_cancel_vote' ,{'consultationSlug': consultation.slug, 'opinionTypeSlug': opinionType.slug, 'opinionSlug': opinion.slug, 'opinionVote': previousVote.id } ) }}">
                                            <button class="btn  btn-info"> {{ 'source.vote.delete'|trans({}, 'CapcoAppBundle') }}</button>
                                            <input type="hidden" name="_csrf_token" value="{{ tokenRemoveVote }}">
                                        </form>
                                    </div>
                                {% endif %}

                            {% endif %}

                            <div class="pull-right  opinion__action-buttons">

                                <div class="opinion__vote-group">
                                    {{ sonata_block_render({'type': 'capco.block.service.share_button'}, {
                                        'url': (url('app_consultation_show_opinion', {'consultationSlug': consultation.slug, 'opinionTypeSlug': opinionType.slug, 'opinionSlug': opinion.slug}) ~ '#details'),
                                        'title': opinion.title,
                                        'btn_classes': 'btn-dark-gray  btn--outline',
                                    }) }}
                                </div>

                                <div class="opinion__vote-group">
                                    {% if opinion.reports | length > 0 %}
                                        <button disabled="disabled" class="btn  btn-dark-gray"><i class="cap cap-flag-1"></i> {{ 'opinion.report.reported'|trans({}, 'CapcoAppBundle') }}</button>
                                    {% else %}
                                        <a href="{{ path('app_report_opinion' ,{'consultationSlug': consultation.slug, 'opinionTypeSlug': opinionType.slug, 'opinionSlug': opinion.slug } ) }}" class="btn  btn-dark-gray  btn--outline  connection-popover-js"><i class="cap cap-flag-1"></i> {{ 'opinion.report.submit'|trans({}, 'CapcoAppBundle') }}</a>
                                    {% endif %}
                                </div>

                                {% if opinion.canContribute and app.user is not null and app.user == opinion.Author %}
                                    <div class="opinion__vote-group">
                                        <a href="{{ path('app_consultation_edit_opinion' ,{'consultationSlug': consultation.slug, 'opinionTypeSlug': opinion.opinionType.slug, 'opinionSlug': opinion.slug } ) }}" class="btn  btn-dark-gray  btn--outline"><i class="cap cap-pencil-1"></i> {{ 'opinion.update.button'|trans({}, 'CapcoAppBundle') }}</a>
                                    </div>
                                {% endif %}

                            </div>

                        </div> <!-- .opinion__buttons -->

                        <div class="panel-group" id="accordion">
                            {% set tokenSource = csrf_token('source_vote') %}
                            <div class="panel panel-default">
                                <div class=" sources__panel  panel-heading" data-toggle="collapse" data-target="#collapseOne" style="cursor:pointer;">
                                    <h4 class="panel-title">
                                        {% transchoice (sources|length) with {'%count%': (sources|length)} from 'CapcoAppBundle' %}source.show.count{% endtranschoice %}
                                        {% if sources|length > 0 %} <i class="cap cap-arrow-67 pull-right"></i>{% endif %}
                                    </h4>
                                    {% if opinion.canContribute %}
                                        <p class="sources__btn"><a id="addSourceLink" href="{{ path('app_new_source' ,{'consultationSlug': consultation.slug, 'opinionTypeSlug': opinionType.slug, 'opinionSlug': opinion.slug} ) }}" class="btn-sm btn btn-default connection-popover-js" data-container="body"><i class="cap cap-add-1"></i> {{ 'source.create.button'|trans({}, 'CapcoAppBundle') }}</a></p>
                                    {% endif %}
                                </div>
                                {% if sources|length > 0 %}
                                <div id="collapseOne" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingOne">
                                    <div class="panel-body">
                                        {% for source in sources %}
                                            <div class="media" id="source{{ source.id }}">
                                                {%  set avatar = source.Author.Media|capco_default_avatar %}
                                                {% if avatar != null %}
                                                    <a class="pull-left media-middle" href="{{ path('capco_user_profile_show_all', {'slug': source.Author.slug}) }}">
                                                        {% thumbnail avatar, 'avatar_source' with {'title': source.Author.username, 'alt': source.Author.username, 'class': 'img-circle  pull-left'} %}
                                                    </a>
                                                {% else %}
                                                    <a class="pull-left" href="{{ path('capco_user_profile_show_all', {'slug': source.Author.slug}) }}">
                                                        <svg version="1.1" id="Calque_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="45px" height="45px" viewBox="0 0 200 200" enable-background="new 0 0 200 200" xml:space="preserve"><circle fill="{{ capco_site_color_value('color.section.bg')  }}" cx="100" cy="100" r="97.617"/><g><path fill="none" stroke="#FFFFFF" stroke-width="3" stroke-linejoin="round" stroke-miterlimit="10" d="M100,160.011h68.011c0,0,0-12.163-5.916-23.993c-4.41-8.819-22.024-14.039-45.683-22.908V95.367c0,0,7.239-6.661,7.239-18.49c2.959,0,5.916-11.826,0-14.785c0-1.754,7.927-16.569,5.916-26.613c-2.957-14.786-44.353-14.786-47.309-2.955c-17.742,0-5.915,27.169-5.915,29.568c-5.913,2.959-2.957,14.785,0,14.785c0,11.829,7.238,17.473,7.238,17.473v18.759c-23.655,8.875-41.273,14.089-45.682,22.908c-5.911,11.83-5.911,23.993-5.911,23.993H100z"/></g></svg>
                                                    </a>
                                                {% endif %}
                                                <div class="media-body">
                                                    <h4 class="media-heading h4" id="source{{ source.id }}"><span class="label label-info">{{ source.Category.title }}</span>
                                                        {% if source.Media %}
                                                            <a href="{{ path('sonata_media_download', {'id': source.Media|sonata_urlsafeid }) }}">{{ source.title }}</a>
                                                        {% endif %}
                                                        {% if source.link %}
                                                            <a rel="nofollow" href="{{ source.link }}" class="external-link">{{ source.title }}</a>
                                                        {% endif %}
                                                    </h4>
                                                    <p class="excerpt">
                                                        {{ source.body }}
                                                    </p>
                                                    {% if false == source.canContribute %}
                                                        <button disabled="disabled" class="btn  btn-dark-gray  btn-xs"><i class="cap cap-hand-like-2"></i> {{ 'source.vote.submit'|trans({}, 'CapcoAppBundle') }}</button>
                                                    {% else %}
                                                        <form method="POST" style="display: inline-block;" action="{{ path('app_consultation_vote_source' ,{'consultationSlug': consultation.slug, 'opinionTypeSlug': opinionType.slug, 'opinionSlug': opinion.slug, 'sourceSlug': source.slug } ) }}">
                                                            {% if source.userHasVote(app.user) %}
                                                            <button class="btn  btn-danger  btn-xs"> {{ 'source.vote.delete'|trans({}, 'CapcoAppBundle') }}</button>
                                                            {% else %}
                                                            <button class="btn  btn-success  btn--outline  btn-xs"><i class="cap cap-hand-like-2"></i> {{ 'source.vote.submit'|trans({}, 'CapcoAppBundle') }}</button>
                                                            {% endif %}
                                                            <input type="hidden" name="_csrf_token" value="{{ tokenSource }}">
                                                        </form>
                                                    {% endif %}
                                                    <span class="nb-votes">{{ source.voteCountSource }}</span>

                                                    {% if source.reports | length > 0 %}
                                                        <button disabled="disabled" class="btn btn-xs btn-dark-gray"><i class="cap cap-flag-1"></i> {{ 'source.report.reported'|trans({}, 'CapcoAppBundle') }}</button>
                                                    {% else %}
                                                        <a href="{{ path('app_report_source' ,{'consultationSlug': consultation.slug, 'opinionTypeSlug': opinionType.slug, 'opinionSlug': opinion.slug, 'sourceSlug': source.slug } ) }}" class="btn btn-xs btn-dark-gray  btn--outline"><i class="cap cap-flag-1"></i> {{ 'source.report.submit'|trans({}, 'CapcoAppBundle') }}</a>
                                                    {% endif %}

                                                    {% if app.user is not null and app.user == source.Author %}
                                                        <a href="{{ path('app_edit_source' ,{'consultationSlug': consultation.slug, 'opinionTypeSlug': opinionType.slug, 'opinionSlug': opinion.slug, 'sourceSlug': source.slug} ) }}" class="btn  btn-dark-gray  btn--outline  btn-xs"><i class="cap cap-pencil-1"></i> {{ 'source.update.button'|trans({}, 'CapcoAppBundle') }}</a>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        {% endfor %}
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div> <!-- .panel-group -->
                    </div> <!-- .opinion__description -->
                </div>
                <div class="row">
                    <div class="col-sm-12  col-md-6">
                        {% if opinion.canContribute %}
                            {% set argType = 1 %}
                            {% set form = argumentFormYes %}
                            {% include '@CapcoApp/Argument/create.html.twig' %}
                        {% endif %}
                        {{ render(controller('CapcoAppBundle:Argument:showArguments', {'consultation': consultation, 'opinionType': opinionType, 'opinion': opinion, 'type': 1, 'form': sortArgumentsForm, 'argumentSort': argumentSort})) }}
                    </div>
                    <div class="col-sm-12  col-md-6">
                        {% if opinion.canContribute %}
                            {% set argType = 0 %}
                            {% set form = argumentFormNo %}
                            {% include '@CapcoApp/Argument/create.html.twig' %}
                        {% endif %}
                        {{ render(controller('CapcoAppBundle:Argument:showArguments', {'consultation': consultation, 'opinionType': opinionType, 'opinion': opinion, 'type': 0, 'form': sortArgumentsForm, 'argumentSort': argumentSort})) }}
                    </div>
                </div>
            </div> <!-- col-xs-12  col-sm-4  col-md-3 -->
        </div> <!-- .row -->
    </div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script type="text/javascript">
        $("#addSourceLink").on('click', function (e) {
            e.stopPropagation();
        });
        {% if null == app.user %}
            App.module.initPopovers('.connection-popover-js', {
                placement: "top",
                html: "true",
                trigger: "focus",
                title: "{{ 'user.login.popover.title'|trans({}, 'CapcoAppBundle') }}",
                content: "<p>{{ 'user.login.popover.body'|trans({}, 'CapcoAppBundle') }}</p><p><a href='{{ path('fos_user_registration_register') }}' class='btn  btn-success  center-block'>{{ 'user.login.popover.signin'|trans({}, 'CapcoAppBundle') }}</a></p><p><a href='{{ path('fos_user_security_login') }}' class='btn  btn-default  center-block'>{{ 'user.login.popover.login'|trans({}, 'CapcoAppBundle') }}</a></p>"
            });
        {% endif %}
    </script>
{% endblock %}
